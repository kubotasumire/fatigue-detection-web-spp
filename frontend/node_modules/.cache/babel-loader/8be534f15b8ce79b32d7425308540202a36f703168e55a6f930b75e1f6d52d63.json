{"ast":null,"code":"import * as WebGPUConstants from \"./webgpuConstants.js\";\n/** @internal */\nexport class WebGPUQuerySet {\n  get querySet() {\n    return this._querySet;\n  }\n  constructor(engine, count, type, device, bufferManager, canUseMultipleBuffers = true, label) {\n    this._dstBuffers = [];\n    this._engine = engine;\n    this._device = device;\n    this._bufferManager = bufferManager;\n    this._count = count;\n    this._canUseMultipleBuffers = canUseMultipleBuffers;\n    this._querySet = device.createQuerySet({\n      label: label ?? \"QuerySet\",\n      type,\n      count\n    });\n    this._queryBuffer = bufferManager.createRawBuffer(8 * count, WebGPUConstants.BufferUsage.QueryResolve | WebGPUConstants.BufferUsage.CopySrc, undefined, \"QueryBuffer\");\n    if (!canUseMultipleBuffers) {\n      this._dstBuffers.push(this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst, undefined, \"QueryBufferNoMultipleBuffers\"));\n    }\n  }\n  _getBuffer(firstQuery, queryCount) {\n    if (!this._canUseMultipleBuffers && this._dstBuffers.length === 0) {\n      return null;\n    }\n    const encoderResult = this._device.createCommandEncoder();\n    let buffer;\n    if (this._dstBuffers.length === 0) {\n      buffer = this._bufferManager.createRawBuffer(8 * this._count, WebGPUConstants.BufferUsage.MapRead | WebGPUConstants.BufferUsage.CopyDst, undefined, \"QueryBufferAdditionalBuffer\");\n    } else {\n      buffer = this._dstBuffers[this._dstBuffers.length - 1];\n      this._dstBuffers.length--;\n    }\n    encoderResult.resolveQuerySet(this._querySet, firstQuery, queryCount, this._queryBuffer, 0);\n    encoderResult.copyBufferToBuffer(this._queryBuffer, 0, buffer, 0, 8 * queryCount);\n    this._device.queue.submit([encoderResult.finish()]);\n    return buffer;\n  }\n  async readValues(firstQuery = 0, queryCount = 1) {\n    const buffer = this._getBuffer(firstQuery, queryCount);\n    if (buffer === null) {\n      return null;\n    }\n    const engineId = this._engine.uniqueId;\n    return buffer.mapAsync(WebGPUConstants.MapMode.Read).then(() => {\n      const arrayBuf = new BigUint64Array(buffer.getMappedRange()).slice();\n      buffer.unmap();\n      this._dstBuffers[this._dstBuffers.length] = buffer;\n      return arrayBuf;\n    }, err => {\n      if (this._engine.isDisposed || this._engine.uniqueId !== engineId) {\n        // Engine disposed or context loss/restoration\n        return null;\n      }\n      throw err;\n    });\n  }\n  async readValue(firstQuery = 0) {\n    const buffer = this._getBuffer(firstQuery, 1);\n    if (buffer === null) {\n      return null;\n    }\n    const engineId = this._engine.uniqueId;\n    return buffer.mapAsync(WebGPUConstants.MapMode.Read).then(() => {\n      const arrayBuf = new BigUint64Array(buffer.getMappedRange());\n      const value = Number(arrayBuf[0]);\n      buffer.unmap();\n      this._dstBuffers[this._dstBuffers.length] = buffer;\n      return value;\n    }, err => {\n      if (this._engine.isDisposed || this._engine.uniqueId !== engineId) {\n        // Engine disposed or context loss/restoration\n        return 0;\n      }\n      throw err;\n    });\n  }\n  async readTwoValuesAndSubtract(firstQuery = 0) {\n    const buffer = this._getBuffer(firstQuery, 2);\n    if (buffer === null) {\n      return null;\n    }\n    const engineId = this._engine.uniqueId;\n    return buffer.mapAsync(WebGPUConstants.MapMode.Read).then(() => {\n      const arrayBuf = new BigUint64Array(buffer.getMappedRange());\n      const value = Number(arrayBuf[1] - arrayBuf[0]);\n      buffer.unmap();\n      this._dstBuffers[this._dstBuffers.length] = buffer;\n      return value;\n    }, err => {\n      if (this._engine.isDisposed || this._engine.uniqueId !== engineId) {\n        // Engine disposed or context loss/restoration\n        return 0;\n      }\n      throw err;\n    });\n  }\n  dispose() {\n    this._querySet.destroy();\n    this._bufferManager.releaseBuffer(this._queryBuffer);\n    for (let i = 0; i < this._dstBuffers.length; ++i) {\n      this._bufferManager.releaseBuffer(this._dstBuffers[i]);\n    }\n  }\n}\n//# sourceMappingURL=webgpuQuerySet.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}