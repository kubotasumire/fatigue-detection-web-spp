{"ast":null,"code":"import { __decorate } from \"../../tslib.es6.js\";\nimport { serialize, serializeAsTexture, expandToProperty } from \"../../Misc/decorators.js\";\nimport { MaterialFlags } from \"../materialFlags.js\";\nimport { MaterialPluginBase } from \"../materialPluginBase.js\";\nimport { MaterialDefines } from \"../materialDefines.js\";\nimport { BindTextureMatrix, PrepareDefinesForMergedUV } from \"../materialHelper.functions.js\";\n/**\n * @internal\n */\nexport class MaterialIridescenceDefines extends MaterialDefines {\n  constructor() {\n    super(...arguments);\n    this.IRIDESCENCE = false;\n    this.IRIDESCENCE_TEXTURE = false;\n    this.IRIDESCENCE_TEXTUREDIRECTUV = 0;\n    this.IRIDESCENCE_THICKNESS_TEXTURE = false;\n    this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV = 0;\n    this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE = false;\n  }\n}\n/**\n * Plugin that implements the iridescence (thin film) component of the PBR material\n */\nexport class PBRIridescenceConfiguration extends MaterialPluginBase {\n  /** @internal */\n  _markAllSubMeshesAsTexturesDirty() {\n    this._enable(this._isEnabled);\n    this._internalMarkAllSubMeshesAsTexturesDirty();\n  }\n  constructor(material, addToPluginList = true) {\n    super(material, \"PBRIridescence\", 110, new MaterialIridescenceDefines(), addToPluginList);\n    this._isEnabled = false;\n    /**\n     * Defines if the iridescence is enabled in the material.\n     */\n    this.isEnabled = false;\n    /**\n     * Defines the iridescence layer strength (between 0 and 1) it defaults to 1.\n     */\n    this.intensity = 1;\n    /**\n     * Defines the minimum thickness of the thin-film layer given in nanometers (nm).\n     */\n    this.minimumThickness = PBRIridescenceConfiguration._DefaultMinimumThickness;\n    /**\n     * Defines the maximum thickness of the thin-film layer given in nanometers (nm). This will be the thickness used if not thickness texture has been set.\n     */\n    this.maximumThickness = PBRIridescenceConfiguration._DefaultMaximumThickness;\n    /**\n     * Defines the maximum thickness of the thin-film layer given in nanometers (nm).\n     */\n    this.indexOfRefraction = PBRIridescenceConfiguration._DefaultIndexOfRefraction;\n    this._texture = null;\n    /**\n     * Stores the iridescence intensity in a texture (red channel)\n     */\n    this.texture = null;\n    this._thicknessTexture = null;\n    /**\n     * Stores the iridescence thickness in a texture (green channel)\n     */\n    this.thicknessTexture = null;\n    this._internalMarkAllSubMeshesAsTexturesDirty = material._dirtyCallbacks[1];\n  }\n  isReadyForSubMesh(defines, scene) {\n    if (!this._isEnabled) {\n      return true;\n    }\n    if (defines._areTexturesDirty) {\n      if (scene.texturesEnabled) {\n        if (this._texture && MaterialFlags.IridescenceTextureEnabled) {\n          if (!this._texture.isReadyOrNotBlocking()) {\n            return false;\n          }\n        }\n        if (this._thicknessTexture && MaterialFlags.IridescenceTextureEnabled) {\n          if (!this._thicknessTexture.isReadyOrNotBlocking()) {\n            return false;\n          }\n        }\n      }\n    }\n    return true;\n  }\n  prepareDefinesBeforeAttributes(defines, scene) {\n    if (this._isEnabled) {\n      defines.IRIDESCENCE = true;\n      defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE = this._texture !== null && this._texture._texture === this._thicknessTexture?._texture && this._texture.checkTransformsAreIdentical(this._thicknessTexture);\n      if (defines._areTexturesDirty) {\n        if (scene.texturesEnabled) {\n          if (this._texture && MaterialFlags.IridescenceTextureEnabled) {\n            PrepareDefinesForMergedUV(this._texture, defines, \"IRIDESCENCE_TEXTURE\");\n          } else {\n            defines.IRIDESCENCE_TEXTURE = false;\n          }\n          if (!defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE && this._thicknessTexture && MaterialFlags.IridescenceTextureEnabled) {\n            PrepareDefinesForMergedUV(this._thicknessTexture, defines, \"IRIDESCENCE_THICKNESS_TEXTURE\");\n          } else {\n            defines.IRIDESCENCE_THICKNESS_TEXTURE = false;\n          }\n        }\n      }\n    } else {\n      defines.IRIDESCENCE = false;\n      defines.IRIDESCENCE_TEXTURE = false;\n      defines.IRIDESCENCE_THICKNESS_TEXTURE = false;\n      defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE = false;\n      defines.IRIDESCENCE_TEXTUREDIRECTUV = 0;\n      defines.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV = 0;\n    }\n  }\n  bindForSubMesh(uniformBuffer, scene, engine, subMesh) {\n    if (!this._isEnabled) {\n      return;\n    }\n    const defines = subMesh.materialDefines;\n    const isFrozen = this._material.isFrozen;\n    const identicalTextures = defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;\n    if (!uniformBuffer.useUbo || !isFrozen || !uniformBuffer.isSync) {\n      if (identicalTextures && MaterialFlags.IridescenceTextureEnabled) {\n        uniformBuffer.updateFloat4(\"vIridescenceInfos\", this._texture.coordinatesIndex, this._texture.level, -1, -1);\n        BindTextureMatrix(this._texture, uniformBuffer, \"iridescence\");\n      } else if ((this._texture || this._thicknessTexture) && MaterialFlags.IridescenceTextureEnabled) {\n        uniformBuffer.updateFloat4(\"vIridescenceInfos\", this._texture?.coordinatesIndex ?? 0, this._texture?.level ?? 0, this._thicknessTexture?.coordinatesIndex ?? 0, this._thicknessTexture?.level ?? 0);\n        if (this._texture) {\n          BindTextureMatrix(this._texture, uniformBuffer, \"iridescence\");\n        }\n        if (this._thicknessTexture && !identicalTextures && !defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE) {\n          BindTextureMatrix(this._thicknessTexture, uniformBuffer, \"iridescenceThickness\");\n        }\n      }\n      // Clear Coat General params\n      uniformBuffer.updateFloat4(\"vIridescenceParams\", this.intensity, this.indexOfRefraction, this.minimumThickness, this.maximumThickness);\n    }\n    // Textures\n    if (scene.texturesEnabled) {\n      if (this._texture && MaterialFlags.IridescenceTextureEnabled) {\n        uniformBuffer.setTexture(\"iridescenceSampler\", this._texture);\n      }\n      if (this._thicknessTexture && !identicalTextures && !defines.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE && MaterialFlags.IridescenceTextureEnabled) {\n        uniformBuffer.setTexture(\"iridescenceThicknessSampler\", this._thicknessTexture);\n      }\n    }\n  }\n  hasTexture(texture) {\n    if (this._texture === texture) {\n      return true;\n    }\n    if (this._thicknessTexture === texture) {\n      return true;\n    }\n    return false;\n  }\n  getActiveTextures(activeTextures) {\n    if (this._texture) {\n      activeTextures.push(this._texture);\n    }\n    if (this._thicknessTexture) {\n      activeTextures.push(this._thicknessTexture);\n    }\n  }\n  getAnimatables(animatables) {\n    if (this._texture && this._texture.animations && this._texture.animations.length > 0) {\n      animatables.push(this._texture);\n    }\n    if (this._thicknessTexture && this._thicknessTexture.animations && this._thicknessTexture.animations.length > 0) {\n      animatables.push(this._thicknessTexture);\n    }\n  }\n  dispose(forceDisposeTextures) {\n    if (forceDisposeTextures) {\n      this._texture?.dispose();\n      this._thicknessTexture?.dispose();\n    }\n  }\n  getClassName() {\n    return \"PBRIridescenceConfiguration\";\n  }\n  addFallbacks(defines, fallbacks, currentRank) {\n    if (defines.IRIDESCENCE) {\n      fallbacks.addFallback(currentRank++, \"IRIDESCENCE\");\n    }\n    return currentRank;\n  }\n  getSamplers(samplers) {\n    samplers.push(\"iridescenceSampler\", \"iridescenceThicknessSampler\");\n  }\n  getUniforms() {\n    return {\n      ubo: [{\n        name: \"vIridescenceParams\",\n        size: 4,\n        type: \"vec4\"\n      }, {\n        name: \"vIridescenceInfos\",\n        size: 4,\n        type: \"vec4\"\n      }, {\n        name: \"iridescenceMatrix\",\n        size: 16,\n        type: \"mat4\"\n      }, {\n        name: \"iridescenceThicknessMatrix\",\n        size: 16,\n        type: \"mat4\"\n      }]\n    };\n  }\n}\n/**\n * The default minimum thickness of the thin-film layer given in nanometers (nm).\n * Defaults to 100 nm.\n * @internal\n */\nPBRIridescenceConfiguration._DefaultMinimumThickness = 100;\n/**\n * The default maximum thickness of the thin-film layer given in nanometers (nm).\n * Defaults to 400 nm.\n * @internal\n */\nPBRIridescenceConfiguration._DefaultMaximumThickness = 400;\n/**\n * The default index of refraction of the thin-film layer.\n * Defaults to 1.3\n * @internal\n */\nPBRIridescenceConfiguration._DefaultIndexOfRefraction = 1.3;\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRIridescenceConfiguration.prototype, \"isEnabled\", void 0);\n__decorate([serialize()], PBRIridescenceConfiguration.prototype, \"intensity\", void 0);\n__decorate([serialize()], PBRIridescenceConfiguration.prototype, \"minimumThickness\", void 0);\n__decorate([serialize()], PBRIridescenceConfiguration.prototype, \"maximumThickness\", void 0);\n__decorate([serialize()], PBRIridescenceConfiguration.prototype, \"indexOfRefraction\", void 0);\n__decorate([serializeAsTexture(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRIridescenceConfiguration.prototype, \"texture\", void 0);\n__decorate([serializeAsTexture(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], PBRIridescenceConfiguration.prototype, \"thicknessTexture\", void 0);\n//# sourceMappingURL=pbrIridescenceConfiguration.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}