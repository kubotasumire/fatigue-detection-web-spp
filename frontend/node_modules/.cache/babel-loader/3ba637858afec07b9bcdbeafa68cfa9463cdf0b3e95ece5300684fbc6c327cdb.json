{"ast":null,"code":"import { __decorate } from \"../tslib.es6.js\";\nimport { Material } from \"./material.js\";\nimport { serialize, expandToProperty, serializeAsTexture } from \"../Misc/decorators.js\";\nimport { MaterialFlags } from \"./materialFlags.js\";\nimport { MaterialDefines } from \"./materialDefines.js\";\nimport { MaterialPluginBase } from \"./materialPluginBase.js\";\nimport { BindTextureMatrix, PrepareDefinesForMergedUV } from \"./materialHelper.functions.js\";\n/**\n * @internal\n */\nexport class MaterialDetailMapDefines extends MaterialDefines {\n  constructor() {\n    super(...arguments);\n    this.DETAIL = false;\n    this.DETAILDIRECTUV = 0;\n    this.DETAIL_NORMALBLENDMETHOD = 0;\n  }\n}\n/**\n * Plugin that implements the detail map component of a material\n *\n * Inspired from:\n *   Unity: https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@9.0/manual/Mask-Map-and-Detail-Map.html and https://docs.unity3d.com/Manual/StandardShaderMaterialParameterDetail.html\n *   Unreal: https://docs.unrealengine.com/en-US/Engine/Rendering/Materials/HowTo/DetailTexturing/index.html\n *   Cryengine: https://docs.cryengine.com/display/SDKDOC2/Detail+Maps\n */\nexport class DetailMapConfiguration extends MaterialPluginBase {\n  /** @internal */\n  _markAllSubMeshesAsTexturesDirty() {\n    this._enable(this._isEnabled);\n    this._internalMarkAllSubMeshesAsTexturesDirty();\n  }\n  constructor(material, addToPluginList = true) {\n    super(material, \"DetailMap\", 140, new MaterialDetailMapDefines(), addToPluginList);\n    this._texture = null;\n    /**\n     * Defines how strongly the detail diffuse/albedo channel is blended with the regular diffuse/albedo texture\n     * Bigger values mean stronger blending\n     */\n    this.diffuseBlendLevel = 1;\n    /**\n     * Defines how strongly the detail roughness channel is blended with the regular roughness value\n     * Bigger values mean stronger blending. Only used with PBR materials\n     */\n    this.roughnessBlendLevel = 1;\n    /**\n     * Defines how strong the bump effect from the detail map is\n     * Bigger values mean stronger effect\n     */\n    this.bumpLevel = 1;\n    this._normalBlendMethod = Material.MATERIAL_NORMALBLENDMETHOD_WHITEOUT;\n    this._isEnabled = false;\n    /**\n     * Enable or disable the detail map on this material\n     */\n    this.isEnabled = false;\n    this._internalMarkAllSubMeshesAsTexturesDirty = material._dirtyCallbacks[1];\n  }\n  isReadyForSubMesh(defines, scene, engine) {\n    if (!this._isEnabled) {\n      return true;\n    }\n    if (defines._areTexturesDirty && scene.texturesEnabled) {\n      if (engine.getCaps().standardDerivatives && this._texture && MaterialFlags.DetailTextureEnabled) {\n        // Detail texture cannot be not blocking.\n        if (!this._texture.isReady()) {\n          return false;\n        }\n      }\n    }\n    return true;\n  }\n  prepareDefines(defines, scene) {\n    if (this._isEnabled) {\n      defines.DETAIL_NORMALBLENDMETHOD = this._normalBlendMethod;\n      const engine = scene.getEngine();\n      if (defines._areTexturesDirty) {\n        if (engine.getCaps().standardDerivatives && this._texture && MaterialFlags.DetailTextureEnabled && this._isEnabled) {\n          PrepareDefinesForMergedUV(this._texture, defines, \"DETAIL\");\n          defines.DETAIL_NORMALBLENDMETHOD = this._normalBlendMethod;\n        } else {\n          defines.DETAIL = false;\n        }\n      }\n    } else {\n      defines.DETAIL = false;\n    }\n  }\n  bindForSubMesh(uniformBuffer, scene) {\n    if (!this._isEnabled) {\n      return;\n    }\n    const isFrozen = this._material.isFrozen;\n    if (!uniformBuffer.useUbo || !isFrozen || !uniformBuffer.isSync) {\n      if (this._texture && MaterialFlags.DetailTextureEnabled) {\n        uniformBuffer.updateFloat4(\"vDetailInfos\", this._texture.coordinatesIndex, this.diffuseBlendLevel, this.bumpLevel, this.roughnessBlendLevel);\n        BindTextureMatrix(this._texture, uniformBuffer, \"detail\");\n      }\n    }\n    // Textures\n    if (scene.texturesEnabled) {\n      if (this._texture && MaterialFlags.DetailTextureEnabled) {\n        uniformBuffer.setTexture(\"detailSampler\", this._texture);\n      }\n    }\n  }\n  hasTexture(texture) {\n    if (this._texture === texture) {\n      return true;\n    }\n    return false;\n  }\n  getActiveTextures(activeTextures) {\n    if (this._texture) {\n      activeTextures.push(this._texture);\n    }\n  }\n  getAnimatables(animatables) {\n    if (this._texture && this._texture.animations && this._texture.animations.length > 0) {\n      animatables.push(this._texture);\n    }\n  }\n  dispose(forceDisposeTextures) {\n    if (forceDisposeTextures) {\n      this._texture?.dispose();\n    }\n  }\n  getClassName() {\n    return \"DetailMapConfiguration\";\n  }\n  getSamplers(samplers) {\n    samplers.push(\"detailSampler\");\n  }\n  getUniforms() {\n    return {\n      ubo: [{\n        name: \"vDetailInfos\",\n        size: 4,\n        type: \"vec4\"\n      }, {\n        name: \"detailMatrix\",\n        size: 16,\n        type: \"mat4\"\n      }]\n    };\n  }\n}\n__decorate([serializeAsTexture(\"detailTexture\"), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], DetailMapConfiguration.prototype, \"texture\", void 0);\n__decorate([serialize()], DetailMapConfiguration.prototype, \"diffuseBlendLevel\", void 0);\n__decorate([serialize()], DetailMapConfiguration.prototype, \"roughnessBlendLevel\", void 0);\n__decorate([serialize()], DetailMapConfiguration.prototype, \"bumpLevel\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], DetailMapConfiguration.prototype, \"normalBlendMethod\", void 0);\n__decorate([serialize(), expandToProperty(\"_markAllSubMeshesAsTexturesDirty\")], DetailMapConfiguration.prototype, \"isEnabled\", void 0);\n//# sourceMappingURL=material.detailMapConfiguration.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}