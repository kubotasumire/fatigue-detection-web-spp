{"ast":null,"code":"import * as WebGPUConstants from \"./webgpuConstants.js\";\nimport { WebGPUQuerySet } from \"./webgpuQuerySet.js\";\n/** @internal */\nexport class WebGPUOcclusionQuery {\n  get querySet() {\n    return this._querySet.querySet;\n  }\n  get hasQueries() {\n    return this._currentTotalIndices !== this._availableIndices.length;\n  }\n  canBeginQuery(index) {\n    if (this._frameQuerySetIsDirty === this._engine.frameId || this._queryFrameId[index] === this._engine.frameId) {\n      return false;\n    }\n    const canBegin = this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet !== undefined;\n    if (canBegin) {\n      this._queryFrameId[index] = this._engine.frameId;\n    }\n    return canBegin;\n  }\n  constructor(engine, device, bufferManager, startCount = 50, incrementCount = 100) {\n    this._availableIndices = [];\n    this._frameQuerySetIsDirty = -1;\n    this._queryFrameId = [];\n    this._engine = engine;\n    this._device = device;\n    this._bufferManager = bufferManager;\n    this._frameLastBuffer = -1;\n    this._currentTotalIndices = 0;\n    this._countIncrement = incrementCount;\n    this._allocateNewIndices(startCount);\n  }\n  createQuery() {\n    if (this._availableIndices.length === 0) {\n      this._allocateNewIndices();\n    }\n    const index = this._availableIndices[this._availableIndices.length - 1];\n    this._availableIndices.length--;\n    return index;\n  }\n  deleteQuery(index) {\n    this._availableIndices[this._availableIndices.length] = index;\n  }\n  isQueryResultAvailable(index) {\n    this._retrieveQueryBuffer();\n    return !!this._lastBuffer && index < this._lastBuffer.length;\n  }\n  getQueryResult(index) {\n    return Number(this._lastBuffer?.[index] ?? -1);\n  }\n  _retrieveQueryBuffer() {\n    if (this._lastBuffer && this._frameLastBuffer === this._engine.frameId) {\n      return;\n    }\n    if (this._frameLastBuffer !== this._engine.frameId) {\n      this._frameLastBuffer = this._engine.frameId;\n      this._querySet.readValues(0, this._currentTotalIndices).then(arrayBuffer => {\n        this._lastBuffer = arrayBuffer;\n      });\n    }\n  }\n  _allocateNewIndices(numIndices) {\n    numIndices = numIndices ?? this._countIncrement;\n    this._delayQuerySetDispose();\n    for (let i = 0; i < numIndices; ++i) {\n      this._availableIndices.push(this._currentTotalIndices + i);\n    }\n    this._currentTotalIndices += numIndices;\n    this._querySet = new WebGPUQuerySet(this._engine, this._currentTotalIndices, WebGPUConstants.QueryType.Occlusion, this._device, this._bufferManager, false, \"QuerySet_OcclusionQuery_count_\" + this._currentTotalIndices);\n    this._frameQuerySetIsDirty = this._engine.frameId;\n  }\n  _delayQuerySetDispose() {\n    const querySet = this._querySet;\n    if (querySet) {\n      // Wait a bit before disposing of the queryset, in case some queries are still running for it\n      setTimeout(() => querySet.dispose, 1000);\n    }\n  }\n  dispose() {\n    this._querySet?.dispose();\n    this._availableIndices.length = 0;\n  }\n}\n//# sourceMappingURL=webgpuOcclusionQuery.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}