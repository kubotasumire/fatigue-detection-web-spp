{"ast":null,"code":"import { NodeMaterialBlock } from \"../../nodeMaterialBlock.js\";\nimport { NodeMaterialBlockConnectionPointTypes } from \"../../Enums/nodeMaterialBlockConnectionPointTypes.js\";\nimport { NodeMaterialSystemValues } from \"../../Enums/nodeMaterialSystemValues.js\";\nimport { NodeMaterialBlockTargets } from \"../../Enums/nodeMaterialBlockTargets.js\";\nimport { InputBlock } from \"../Input/inputBlock.js\";\nimport { RegisterClass } from \"../../../../Misc/typeStore.js\";\nimport \"../../../../Shaders/ShadersInclude/fogFragmentDeclaration.js\";\nimport { GetFogState } from \"../../../materialHelper.functions.js\";\n/**\n * Block used to add support for scene fog\n */\nexport class FogBlock extends NodeMaterialBlock {\n  /**\n   * Create a new FogBlock\n   * @param name defines the block name\n   */\n  constructor(name) {\n    super(name, NodeMaterialBlockTargets.VertexAndFragment, false);\n    // Vertex\n    this.registerInput(\"worldPosition\", NodeMaterialBlockConnectionPointTypes.Vector4, false, NodeMaterialBlockTargets.Vertex);\n    this.registerInput(\"view\", NodeMaterialBlockConnectionPointTypes.Matrix, false, NodeMaterialBlockTargets.Vertex);\n    // Fragment\n    this.registerInput(\"input\", NodeMaterialBlockConnectionPointTypes.AutoDetect, false, NodeMaterialBlockTargets.Fragment);\n    this.registerInput(\"fogColor\", NodeMaterialBlockConnectionPointTypes.AutoDetect, false, NodeMaterialBlockTargets.Fragment);\n    this.registerOutput(\"output\", NodeMaterialBlockConnectionPointTypes.Color3, NodeMaterialBlockTargets.Fragment);\n    this.input.addExcludedConnectionPointFromAllowedTypes(NodeMaterialBlockConnectionPointTypes.Color3 | NodeMaterialBlockConnectionPointTypes.Vector3 | NodeMaterialBlockConnectionPointTypes.Color4);\n    this.fogColor.addExcludedConnectionPointFromAllowedTypes(NodeMaterialBlockConnectionPointTypes.Color3 | NodeMaterialBlockConnectionPointTypes.Vector3 | NodeMaterialBlockConnectionPointTypes.Color4);\n  }\n  /**\n   * Gets the current class name\n   * @returns the class name\n   */\n  getClassName() {\n    return \"FogBlock\";\n  }\n  /**\n   * Gets the world position input component\n   */\n  get worldPosition() {\n    return this._inputs[0];\n  }\n  /**\n   * Gets the view input component\n   */\n  get view() {\n    return this._inputs[1];\n  }\n  /**\n   * Gets the color input component\n   */\n  get input() {\n    return this._inputs[2];\n  }\n  /**\n   * Gets the fog color input component\n   */\n  get fogColor() {\n    return this._inputs[3];\n  }\n  /**\n   * Gets the output component\n   */\n  get output() {\n    return this._outputs[0];\n  }\n  autoConfigure(material, additionalFilteringInfo = () => true) {\n    if (!this.view.isConnected) {\n      let viewInput = material.getInputBlockByPredicate(b => b.systemValue === NodeMaterialSystemValues.View && additionalFilteringInfo(b));\n      if (!viewInput) {\n        viewInput = new InputBlock(\"view\");\n        viewInput.setAsSystemValue(NodeMaterialSystemValues.View);\n      }\n      viewInput.output.connectTo(this.view);\n    }\n    if (!this.fogColor.isConnected) {\n      let fogColorInput = material.getInputBlockByPredicate(b => b.systemValue === NodeMaterialSystemValues.FogColor && additionalFilteringInfo(b));\n      if (!fogColorInput) {\n        fogColorInput = new InputBlock(\"fogColor\", undefined, NodeMaterialBlockConnectionPointTypes.Color3);\n        fogColorInput.setAsSystemValue(NodeMaterialSystemValues.FogColor);\n      }\n      fogColorInput.output.connectTo(this.fogColor);\n    }\n  }\n  prepareDefines(mesh, nodeMaterial, defines) {\n    const scene = mesh.getScene();\n    defines.setValue(\"FOG\", nodeMaterial.fogEnabled && GetFogState(mesh, scene));\n  }\n  bind(effect, nodeMaterial, mesh) {\n    if (!mesh) {\n      return;\n    }\n    const scene = mesh.getScene();\n    effect.setFloat4(this._fogParameters, scene.fogMode, scene.fogStart, scene.fogEnd, scene.fogDensity);\n  }\n  _buildBlock(state) {\n    super._buildBlock(state);\n    if (state.target === NodeMaterialBlockTargets.Fragment) {\n      state.sharedData.blocksWithDefines.push(this);\n      state.sharedData.bindableBlocks.push(this);\n      state._emitFunctionFromInclude(\"fogFragmentDeclaration\", `//${this.name}`, {\n        removeUniforms: true,\n        removeVaryings: true,\n        removeIfDef: false,\n        replaceStrings: [{\n          search: /float CalcFogFactor\\(\\)/,\n          replace: \"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)\"\n        }]\n      });\n      const tempFogVariablename = state._getFreeVariableName(\"fog\");\n      const color = this.input;\n      const fogColor = this.fogColor;\n      this._fogParameters = state._getFreeVariableName(\"fogParameters\");\n      const output = this._outputs[0];\n      state._emitUniformFromString(this._fogParameters, \"vec4\");\n      state.compilationString += `#ifdef FOG\\n`;\n      state.compilationString += `float ${tempFogVariablename} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\\n`;\n      state.compilationString += this._declareOutput(output, state) + ` = ${tempFogVariablename} * ${color.associatedVariableName}.rgb + (1.0 - ${tempFogVariablename}) * ${fogColor.associatedVariableName}.rgb;\\n`;\n      state.compilationString += `#else\\n${this._declareOutput(output, state)} =  ${color.associatedVariableName}.rgb;\\n`;\n      state.compilationString += `#endif\\n`;\n    } else {\n      const worldPos = this.worldPosition;\n      const view = this.view;\n      this._fogDistanceName = state._getFreeVariableName(\"vFogDistance\");\n      state._emitVaryingFromString(this._fogDistanceName, \"vec3\");\n      state.compilationString += `${this._fogDistanceName} = (${view.associatedVariableName} * ${worldPos.associatedVariableName}).xyz;\\n`;\n    }\n    return this;\n  }\n}\nRegisterClass(\"BABYLON.FogBlock\", FogBlock);\n//# sourceMappingURL=fogBlock.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}