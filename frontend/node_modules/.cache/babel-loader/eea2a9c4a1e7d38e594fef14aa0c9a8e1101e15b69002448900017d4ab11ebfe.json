{"ast":null,"code":"/**\n * リアルタイムセンサーデータ収集\n * position, rotation, gazeをキャプチャしてバックエンドに送信\n */\n\nclass DataCollector {\n  constructor(sessionId, apiBaseUrl = 'http://localhost:5001') {\n    this.sessionId = sessionId;\n    this.apiBaseUrl = apiBaseUrl;\n    this.isCollecting = false;\n    this.lastMousePos = {\n      x: 0,\n      y: 0\n    };\n    this.lastRotation = {\n      x: 0,\n      y: 0\n    };\n    this.startTime = Date.now();\n\n    // データバッチ処理（効率化のため複数データをまとめて送信）\n    this.dataBatch = [];\n    this.batchSize = 10; // 10フレーム毎に送信\n    this.sendInterval = null;\n  }\n\n  /**\n   * データ収集を開始\n   */\n  start() {\n    this.isCollecting = true;\n    this.startTime = Date.now();\n\n    // マウス移動トラッキング\n    document.addEventListener('mousemove', this.handleMouseMove.bind(this));\n\n    // 定期的にデータを送信\n    this.sendInterval = setInterval(() => {\n      this.flushBatch();\n    }, 100); // 100msごとにバッチ送信\n  }\n\n  /**\n   * データ収集を停止\n   */\n  stop() {\n    this.isCollecting = false;\n    document.removeEventListener('mousemove', this.handleMouseMove.bind(this));\n    if (this.sendInterval) {\n      clearInterval(this.sendInterval);\n    }\n\n    // 残っているデータを送信\n    this.flushBatch();\n  }\n\n  /**\n   * マウス移動イベント処理\n   */\n  handleMouseMove(event) {\n    if (!this.isCollecting) return;\n    const timestamp = Date.now();\n\n    // ウィンドウサイズを基準に正規化\n    const normalizedX = event.clientX / window.innerWidth * 2 - 1;\n    const normalizedY = -(event.clientY / window.innerHeight) * 2 + 1;\n\n    // rotation: マウス移動量から計算\n    // カメラの回転角度を推定\n    const rotationDelta = {\n      x: (normalizedY - this.lastRotation.y) * 0.01,\n      // Y軸周り回転\n      y: (normalizedX - this.lastRotation.x) * 0.01 // X軸周り回転\n    };\n    this.lastRotation.x = normalizedX;\n    this.lastRotation.y = normalizedY;\n\n    // センサーデータを収集\n    const sensorData = {\n      timestamp,\n      position: {\n        x: event.clientX,\n        y: event.clientY\n      },\n      rotation: {\n        x: rotationDelta.x,\n        y: rotationDelta.y\n      },\n      gaze: this.detectGaze(event.clientX, event.clientY)\n    };\n    this.dataBatch.push(sensorData);\n\n    // バッチが満杯なら送信\n    if (this.dataBatch.length >= this.batchSize) {\n      this.flushBatch();\n    }\n  }\n\n  /**\n   * Gaze検出：スクリーン中央の範囲をチェック\n   * Mac 13インチを基準に実装\n   */\n  detectGaze(x, y) {\n    const centerX = window.innerWidth / 2;\n    const centerY = window.innerHeight / 2;\n\n    // 中央領域を定義（例：中央±200px）\n    const gazeRadius = 200;\n    const dx = x - centerX;\n    const dy = y - centerY;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n    if (distance < gazeRadius) {\n      // 中央付近 → オブジェクト検出処理（TODO）\n      return {\n        x: x,\n        y: y,\n        object: this.getGazeObject(x, y),\n        inCenter: true\n      };\n    } else {\n      return {\n        x: x,\n        y: y,\n        object: 'empty',\n        inCenter: false\n      };\n    }\n  }\n\n  /**\n   * マウス位置から対応するオブジェクトを判定\n   * TODO: 3D空間のレイキャスティング結果を使用\n   */\n  getGazeObject(x, y) {\n    // TODO: Three.jsのレイキャスター使用して、3D空間のどのオブジェクトを見ているか判定\n    // 一時的には'empty'を返す\n    return 'empty';\n  }\n\n  /**\n   * バッチデータをバックエンドに送信\n   */\n  flushBatch() {\n    if (this.dataBatch.length === 0) return;\n    const batch = [...this.dataBatch];\n    this.dataBatch = [];\n    batch.forEach(data => {\n      this.sendSensorData(data);\n    });\n  }\n\n  /**\n   * 単一のセンサーデータをバックエンドに送信\n   */\n  async sendSensorData(data) {\n    try {\n      await fetch(`${this.apiBaseUrl}/api/data/sensor`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          sessionId: this.sessionId,\n          data\n        })\n      });\n    } catch (error) {\n      console.error('Error sending sensor data:', error);\n    }\n  }\n\n  /**\n   * クイズ回答を記録\n   */\n  async recordQuizResponse(quizId, selectedAnswer, isCorrect) {\n    try {\n      await fetch(`${this.apiBaseUrl}/api/data/quiz-response`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          sessionId: this.sessionId,\n          quizId,\n          selectedAnswer,\n          isCorrect,\n          timestamp: Date.now()\n        })\n      });\n    } catch (error) {\n      console.error('Error recording quiz response:', error);\n    }\n  }\n}\nexport default DataCollector;","map":{"version":3,"names":["DataCollector","constructor","sessionId","apiBaseUrl","isCollecting","lastMousePos","x","y","lastRotation","startTime","Date","now","dataBatch","batchSize","sendInterval","start","document","addEventListener","handleMouseMove","bind","setInterval","flushBatch","stop","removeEventListener","clearInterval","event","timestamp","normalizedX","clientX","window","innerWidth","normalizedY","clientY","innerHeight","rotationDelta","sensorData","position","rotation","gaze","detectGaze","push","length","centerX","centerY","gazeRadius","dx","dy","distance","Math","sqrt","object","getGazeObject","inCenter","batch","forEach","data","sendSensorData","fetch","method","headers","body","JSON","stringify","error","console","recordQuizResponse","quizId","selectedAnswer","isCorrect"],"sources":["/Users/kubotasumire/Univ./卒論/s-2/fatigue-detection-web-spp/frontend/src/utils/dataCollector.js"],"sourcesContent":["/**\n * リアルタイムセンサーデータ収集\n * position, rotation, gazeをキャプチャしてバックエンドに送信\n */\n\nclass DataCollector {\n  constructor(sessionId, apiBaseUrl = 'http://localhost:5001') {\n    this.sessionId = sessionId;\n    this.apiBaseUrl = apiBaseUrl;\n    this.isCollecting = false;\n    this.lastMousePos = { x: 0, y: 0 };\n    this.lastRotation = { x: 0, y: 0 };\n    this.startTime = Date.now();\n\n    // データバッチ処理（効率化のため複数データをまとめて送信）\n    this.dataBatch = [];\n    this.batchSize = 10; // 10フレーム毎に送信\n    this.sendInterval = null;\n  }\n\n  /**\n   * データ収集を開始\n   */\n  start() {\n    this.isCollecting = true;\n    this.startTime = Date.now();\n\n    // マウス移動トラッキング\n    document.addEventListener('mousemove', this.handleMouseMove.bind(this));\n\n    // 定期的にデータを送信\n    this.sendInterval = setInterval(() => {\n      this.flushBatch();\n    }, 100); // 100msごとにバッチ送信\n  }\n\n  /**\n   * データ収集を停止\n   */\n  stop() {\n    this.isCollecting = false;\n    document.removeEventListener('mousemove', this.handleMouseMove.bind(this));\n\n    if (this.sendInterval) {\n      clearInterval(this.sendInterval);\n    }\n\n    // 残っているデータを送信\n    this.flushBatch();\n  }\n\n  /**\n   * マウス移動イベント処理\n   */\n  handleMouseMove(event) {\n    if (!this.isCollecting) return;\n\n    const timestamp = Date.now();\n\n    // ウィンドウサイズを基準に正規化\n    const normalizedX = (event.clientX / window.innerWidth) * 2 - 1;\n    const normalizedY = -(event.clientY / window.innerHeight) * 2 + 1;\n\n    // rotation: マウス移動量から計算\n    // カメラの回転角度を推定\n    const rotationDelta = {\n      x: (normalizedY - this.lastRotation.y) * 0.01, // Y軸周り回転\n      y: (normalizedX - this.lastRotation.x) * 0.01   // X軸周り回転\n    };\n\n    this.lastRotation.x = normalizedX;\n    this.lastRotation.y = normalizedY;\n\n    // センサーデータを収集\n    const sensorData = {\n      timestamp,\n      position: {\n        x: event.clientX,\n        y: event.clientY\n      },\n      rotation: {\n        x: rotationDelta.x,\n        y: rotationDelta.y\n      },\n      gaze: this.detectGaze(event.clientX, event.clientY)\n    };\n\n    this.dataBatch.push(sensorData);\n\n    // バッチが満杯なら送信\n    if (this.dataBatch.length >= this.batchSize) {\n      this.flushBatch();\n    }\n  }\n\n  /**\n   * Gaze検出：スクリーン中央の範囲をチェック\n   * Mac 13インチを基準に実装\n   */\n  detectGaze(x, y) {\n    const centerX = window.innerWidth / 2;\n    const centerY = window.innerHeight / 2;\n\n    // 中央領域を定義（例：中央±200px）\n    const gazeRadius = 200;\n    const dx = x - centerX;\n    const dy = y - centerY;\n    const distance = Math.sqrt(dx * dx + dy * dy);\n\n    if (distance < gazeRadius) {\n      // 中央付近 → オブジェクト検出処理（TODO）\n      return {\n        x: x,\n        y: y,\n        object: this.getGazeObject(x, y),\n        inCenter: true\n      };\n    } else {\n      return {\n        x: x,\n        y: y,\n        object: 'empty',\n        inCenter: false\n      };\n    }\n  }\n\n  /**\n   * マウス位置から対応するオブジェクトを判定\n   * TODO: 3D空間のレイキャスティング結果を使用\n   */\n  getGazeObject(x, y) {\n    // TODO: Three.jsのレイキャスター使用して、3D空間のどのオブジェクトを見ているか判定\n    // 一時的には'empty'を返す\n    return 'empty';\n  }\n\n  /**\n   * バッチデータをバックエンドに送信\n   */\n  flushBatch() {\n    if (this.dataBatch.length === 0) return;\n\n    const batch = [...this.dataBatch];\n    this.dataBatch = [];\n\n    batch.forEach(data => {\n      this.sendSensorData(data);\n    });\n  }\n\n  /**\n   * 単一のセンサーデータをバックエンドに送信\n   */\n  async sendSensorData(data) {\n    try {\n      await fetch(`${this.apiBaseUrl}/api/data/sensor`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          sessionId: this.sessionId,\n          data\n        })\n      });\n    } catch (error) {\n      console.error('Error sending sensor data:', error);\n    }\n  }\n\n  /**\n   * クイズ回答を記録\n   */\n  async recordQuizResponse(quizId, selectedAnswer, isCorrect) {\n    try {\n      await fetch(`${this.apiBaseUrl}/api/data/quiz-response`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          sessionId: this.sessionId,\n          quizId,\n          selectedAnswer,\n          isCorrect,\n          timestamp: Date.now()\n        })\n      });\n    } catch (error) {\n      console.error('Error recording quiz response:', error);\n    }\n  }\n}\n\nexport default DataCollector;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}